{% extends "base_search.html" %}

{% block title %}<title>VVZ API - Search</title>{% endblock title %}

{% block content %}

<main class="grow p-4 sm:p-8">
    <div class="flex flex-col max-w-5xl mx-auto space-y-4">

        {% if results.total %}
        <div class="text-gray-600">
            <p class="text-xs pb-2">Found {{ results.total }} result{{ results.total|pluralize }} where
                <span class="bg-base-100 py-0.5 px-1 rounded">{{ results.filters_used|join(', ') }}</span>
            </p>

            <div class="collapse bg-base-100 border-base-300 border">
                <input type="checkbox" />
                <div class="collapse-title">
                    Search options
                </div>
                <div class="collapse-content text-sm">
                    Showing
                    <select name="limit" class="select select-ghost select-sm max-w-fit">
                        <option value="20">20</option>
                        <option value="40">40</option>
                        <option value="60">60</option>
                        <option value="80">80</option>
                        <option value="100">100</option>
                    </select>
                    results ordered by
                    <select name="order_by" class="select select-ghost select-sm max-w-fit">
                        <option value="title">English title</option>
                        <option value="title_german">German title</option>
                        <option value="number">number</option>
                        <option selected value="year">year</option>
                        <option value="semester">semester</option>
                        <option value="lecturer">lecturer name</option>
                        <option value="department">department</option>
                        <option value="level">level</option>
                        <option value="language">language</option>
                    </select>
                    <select name="order" class="select select-ghost select-sm max-w-fit">
                        <option value="asc">ascending</option>
                        <option selected value="desc">descending</option>
                    </select>

                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            const inputs = document.querySelectorAll('select[name="limit"], select[name="order_by"], select[name="order"]');
                            const currentUrl = new URL(window.location);
                            const params = currentUrl.searchParams;
                            inputs.forEach(input => {
                                const paramValue = params.get(input.name);
                                if (paramValue) {
                                    input.value = paramValue;
                                }
                                input.addEventListener('change', (event) => {
                                    const url = new URL(window.location);
                                    url.searchParams.set(event.target.name, event.target.value);
                                    url.searchParams.set('page', '1');
                                    window.location.href = url.toString();
                                });

                            });
                        });
                    </script>
                </div>
            </div>
        </div>

        {% include "components/pagination.html" %}

        {% for unit in results.results %}
        <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow flex-row p-4 gap-4">
            <a href="/unit/{{ unit.id }}" class="grow">
                <div class="flex flex-col gap-2 w-full">

                    <div>
                        <h3 class="text-lg font-bold text-neutral leading-tight">
                            {{ unit.title_english if unit.title_english else unit.title }}
                        </h3>
                        <h4 class="text-sm text-base-content/70 italic">
                            {{ unit.title }}
                        </h4>
                    </div>

                    <div class="flex flex-wrap gap-2 text-xs font-mono mt-1">
                        <span class="badge badge-ghost h-fit p-1">
                            {{ unit.number }}
                        </span>

                        <span class="badge badge-ghost h-fit p-1">
                            {{ unit.semkez }}
                        </span>

                        {% if unit.credits %}
                        <span class="badge badge-info h-fit p-1">
                            {{ unit.credits|trim_float }} Credits
                        </span>
                        {% endif %}

                        {% if unit.levels %}
                        <span class="badge badge-success h-fit p-1 flex-wrap justify-start">
                            {% for level in unit.levels %}
                            <span title="{{ level.description() }}">
                                {{ level }}{% if not loop.last %}, {% endif %}
                            </span>
                            {% endfor %}
                        </span>
                        {% endif %}

                        {% if unit.departments %}
                        <span class="badge badge-neutral h-fit p-1 flex-wrap justify-start">
                            {% for dept in unit.departments %}
                            <span class="text-nowrap" title="{{ dept }}">{{ dept.short() }}{% if not loop.last %},
                                {% endif %}</span>
                            {% endfor %}
                        </span>
                        {% endif %}
                    </div>

                    <p class="text-sm text-base-content/80 leading-relaxed line-clamp-3 mt-1">
                        {% if unit.abstract_english %}
                        {{ unit.abstract_english }}
                        {% elif unit.abstract %}
                        {{ unit.abstract }}
                        {% else %}
                        <span class="text-base-content/50 italic">No description available.</span>
                        {% endif %}
                    </p>
                </div>
            </a>
            <a class="btn btn-sm btn-ghost h-fit" target="_blank"
                href="https://www.vvz.ethz.ch/Vorlesungsverzeichnis/lerneinheit.view?lerneinheitId={{ unit.id }}&semkez={{ unit.semkez }}&lang=en&ansicht=ALLE">VVZ</a>
        </div>
        {% endfor %}

        {% include "components/pagination.html" %}


        {% else %}
        <div class="text-center text-gray-500 mt-10">
            <p class="text-xs">No results found where
                <span class="bg-base-100 py-0.5 px-1 rounded">{{ results.filters_used|join(', ') }}</span>
            </p>
        </div>
        {% endif %}


    </div>
</main>

</body>

{% endblock content %}
