{% extends "base_search.html" %}

{% block head %}
<link rel="preconnect" href="https://cr.vsos.ethz.ch"/>
<link rel="cannonical" href="{{ url_for('unit_detail', unit_id=newest_unit_id) }}"/>
{% endblock head %}

{% block title %}
<title>VVZ - {{ unit.title_english }}</title>
<meta name="description"
    content="VVZ API â€” Details for {{ unit.number }} - {{ unit.title_english if unit.title_english else unit.title }}." />
<meta property="og:description"
    content="Details for {{ unit.number }} - {{ unit.title_english if unit.title_english else unit.title }}." />
{% endblock title %}

{% block content %}
<main class="grow p-4 sm:p-8">
    <div class="max-w-7xl mx-auto space-y-8">
        <header class="card bg-base-100 shadow-sm">
            <div class="card-body flex-row gap-4 justify-between">
                <div class="flex flex-col gap-2">
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                        <span class="badge badge-ghost font-mono h-fit p-1">{{ unit.number }}</span>
                        {% if unit.credits %}
                        <span class="badge badge-info font-bold h-fit p-1"> {{ unit.credits|trim_float }}
                            Credits</span>
                        {% endif %}

                        {% if unit.levels %}
                        <span class="badge badge-success h-fit p-1 flex-wrap justify-start">
                            {% for level in unit.levels %}
                            <span title="{{ level.description() }}">
                                {{ level }}{% if not loop.last %}, {% endif %}
                            </span>
                            {% endfor %}
                        </span>
                        {% endif %}

                        {% if unit.departments %}
                        <span class="badge badge-neutral h-fit p-1 flex-wrap justify-start">
                            {% for dept in unit.departments %}
                            <span title="{{ dept }}">{{ dept.short() }}{% if not loop.last %}, {% endif %}</span>
                            {% endfor %}
                        </span>
                        {% endif %}
                        {% if semkezs %}


                        <select onchange="window.location = this.value;" aria-label="Select Semester"
                            class="badge font-mono h-fit p-1.5 cursor-pointer {% if is_outdated %}bg-warning badge-warning{% else %}bg-base-200 badge-ghost{% endif %}">
                            {% for id, sk in semkezs %}
                            <option value="{{ url_for('unit_detail', unit_id=id) }}"
                                {% if sk==unit.semkez %}selected disabled{% endif %}>
                                {{ sk }}
                            </option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <span class="badge badge-ghost font-mono h-fit p-1">{{ unit.semkez }}</span>
                        {% endif %}
                    </div>

                    {% if is_outdated %}
                    <div class="alert alert-warning p-2 text-sm max-w-md">
                        <span>This unit is from a past semester. Please check the latest semester for more up-to-date information.</span>
                    </div>
                    {% endif %}

                    <h1 class="text-3xl font-bold text-base-content">
                        {{ unit.title_english if unit.title_english else unit.title }}
                    </h1>
                    {% if unit.title_english and unit.title and unit.title != unit.title_english %}
                    <h2 class="text-xl text-base-content/70 font-medium">{{ unit.title }}</h2>
                    {% endif %}

                    {% if lecturers %}
                    <div class="mt-4 text-sm text-base-content/80">
                        {% if lecturers == examiners %}
                        <span class="font-bold">Lecturers & Examiners: </span>
                        {% else %}
                        <span class="font-bold">Lecturers: </span>
                        {% endif %}
                        {% for lecturer in lecturers %}
                        <span class="mr-2">{{ lecturer.surname }}
                            {{ lecturer.name }}{% if not loop.last %},{% endif %}</span>
                        {% endfor %}
                    </div>
                    {% if examiners and examiners != lecturers %}
                    <div class="mt-4 text-sm text-base-content/80">
                        <span class="font-bold">Examiners: </span>
                        {% for lecturer in examiners %}
                        <span class="mr-2">{{ lecturer.surname }}
                            {{ lecturer.name }}{% if not loop.last %},{% endif %}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endif %}

                    {% if unit.comment or unit.comment_english %}
                    <div class="mt-4 p-4 bg-base-200 rounded-md text-base-content/80 italic whitespace-pre-line">
                        {{- unit.comment_english if unit.comment_english else unit.comment -}}
                    </div>
                    {% endif %}
                </div>

                <div class="flex gap-2 flex-wrap justify-end h-fit">
                    <a target="_blank"
                        href="https://www.vvz.ethz.ch/Vorlesungsverzeichnis/lerneinheit.view?lerneinheitId={{ unit.id }}&semkez={{ unit.semkez }}&lang=en&ansicht=ALLE"
                        class="btn btn-sm btn-outline" title="VVZ">
                        VVZ
                        <span class="[&>svg]:size-4">{% include "icons/external.svg" %}</span>
                    </a>
                    <a target="_blank" href="https://coursereview.ch/course/{{ unit.number }}"
                        class="btn btn-sm btn-outline" title="CourseReview">
                        <span id="coursereview">CR n/a</span>
                        <span class="[&>svg]:size-4">{% include "icons/external.svg" %}</span>
                        <script>
                            window.addEventListener('DOMContentLoaded', function () {
                              fetch("https://cr.vsos.ethz.ch/getRatings?course={{ unit.number }}")
                                  .then(response => response.json())
                                  .then(data => {
                                      if (!data || data.length === 0) {
                                          return;
                                      }
                                      const mapper = rating => {
                                          return (rating.Recommended + rating.Engaging + rating.Difficulty + rating.Effort + rating.Resources) / 5;
                                      };
                                      const average_rating = data.map(mapper).reduce((a, b) => a + b, 0) / data.length;
                                      if (!isNaN(average_rating)) {
                                          document.getElementById("coursereview").innerText = `CR ${average_rating.toFixed(2)}/5`;
                                      }
                                  }).catch(error => {
                                      console.error("Error fetching CourseReview ratings:", error);
                                  });
                            });
                        </script>
                    </a>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-2 space-y-6 [&>section>*>p]:whitespace-pre-wrap font-sans">

                {% if unit.abstract or unit.abstract_english %}
                <section class="card bg-base-100 shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold border-b border-base-200 pb-2 mb-4">Abstract</h3>
                        <p class="max-w-none text-base-content/80 font-sans">
                            {{- unit.abstract_english if unit.abstract_english else unit.abstract -}}
                        </p>
                    </div>
                </section>
                {% endif %}

                {% if unit.objective or unit.objective_english %}
                <section class="card bg-base-100 shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold border-b border-base-200 pb-2 mb-4">Objective</h3>
                        <p class="max-w-none text-base-content/80">
                            {{- unit.objective_english if unit.objective_english else unit.objective -}}
                        </p>
                    </div>
                </section>
                {% endif %}

                {% if unit.content or unit.content_english %}
                <section class="card bg-base-100 shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold border-b border-base-200 pb-2 mb-4">Content</h3>
                        <p class="max-w-none text-base-content/80">
                            {{- unit.content_english if unit.content_english else unit.content -}}
                        </p>
                    </div>
                </section>
                {% endif %}

                {% if unit.literature or unit.literature_english or unit.lecture_notes or unit.learning_materials %}
                <section class="card bg-base-100 shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title text-lg font-bold border-b border-base-200 pb-2 mb-4">Resources</h3>

                        {% if unit.lecture_notes or unit.lecture_notes_english %}
                        <div class="mb-4">
                            <h4 class="font-bold text-base-content text-sm mb-1">Lecture Notes</h4>
                            <p class="text-sm text-base-content/80">{{- unit.lecture_notes_english if
                                unit.lecture_notes_english else unit.lecture_notes -}}</p>
                        </div>
                        {% endif %}

                        {% if unit.literature or unit.literature_english %}
                        <div class="mb-4">
                            <h4 class="font-bold text-base-content text-sm mb-1">Literature</h4>
                            <p class="text-sm text-base-content/80">
                                {{- unit.literature_english if unit.literature_english else unit.literature -}}</p>
                        </div>
                        {% endif %}

                        {% if unit.learning_materials %}
                        <div class="mb-4">
                            <h4 class="font-bold text-base-content text-sm mb-1">Learning Materials (Links)</h4>
                            <ul class="list-disc list-inside text-sm text-neutral">
                                {% for category, links in unit.learning_materials.items() %}
                                <li class="font-semibold text-base-content list-none mt-2">{{ category }}</li>
                                {% for link in links %}
                                <li class="ml-4 break-all"><a href="{{ link.url }}" target="_blank"
                                        class="link link-hover">
                                        {{ link.title or link.url }}</a></li>
                                {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </section>
                {% endif %}
            </div>

            <div class="space-y-6">

                <section class="card bg-base-100 shadow-sm text-sm">
                    <div class="card-body p-5">
                        <h3 class="font-bold text-base-content border-b border-base-200 pb-2 mb-3">General Information
                        </h3>
                        <dl class="space-y-2">
                            {% if unit.language %}
                            <div class="flex justify-between">
                                <dt class="text-base-content/70">Language</dt>
                                <dd class="font-medium text-base-content">{{ unit.language }}</dd>
                            </div>
                            {% endif %}

                            {% if unit.levels %}
                            <div class="flex justify-between">
                                <dt class="text-base-content/70">Levels</dt>
                                <dd class="font-medium text-base-content text-right">
                                    {% for level in unit.levels %}
                                    <span title="{{ level.description() }}">
                                        {{ level }}{% if not loop.last %}, {% endif %}
                                    </span>
                                    {% endfor %}
                                </dd>
                            </div>
                            {% endif %}

                            {% if unit.course_frequency %}
                            <div class="flex justify-between">
                                <dt class="text-base-content/70">Frequency</dt>
                                <dd class="font-medium text-base-content">{{ unit.course_frequency }}</dd>
                            </div>
                            {% endif %}
                        </dl>
                    </div>
                </section>

                {% if unit.exam_type or unit.exam_language or unit.exam_duration %}
                <section class="card bg-base-100 shadow-sm text-sm">
                    <div class="card-body p-5">
                        <h3 class="font-bold text-base-content border-b border-base-200 pb-2 mb-3">Examination</h3>
                        <dl class="space-y-3">
                            {% if unit.exam_type %}
                            <div>
                                <dt class="text-base-content/60 text-xs uppercase tracking-wide">Type</dt>
                                <dd class="font-medium text-base-content">{{ unit.exam_type }}</dd>
                            </div>
                            {% endif %}

                            {% if unit.exam_mode %}
                            <div>
                                <dt class="text-base-content/60 text-xs uppercase tracking-wide">Mode</dt>
                                <dd class="font-medium text-base-content">{{ unit.exam_mode }}</dd>
                            </div>
                            {% endif %}

                            {% if unit.written_aids %}
                            <div>
                                <dt class="text-base-content/60 text-xs uppercase tracking-wide">Aids</dt>
                                <dd class="text-base-content/80">{{ unit.written_aids }}</dd>
                            </div>
                            {% endif %}

                            {% if unit.digital %}
                            <div>
                                <dt class="text-base-content/60 text-xs uppercase tracking-wide">Digital</dt>
                                <dd class="text-base-content/80">{{ unit.digital }}</dd>
                            </div>
                            {% endif %}
                        </dl>
                        {% if unit.additional_info %}
                        <div class="mt-3 pt-3 border-t border-base-200 text-base-content/70 italic">
                            {{ unit.additional_info }}
                        </div>
                        {% endif %}
                    </div>
                </section>
                {% endif %}

                {% if unit.max_places or unit.signup_start or unit.signup_end or unit.priority %}
                <section class="card bg-base-100 shadow-sm text-sm">
                    <div class="card-body p-5">
                        <h3 class="font-bold text-base-content border-b border-base-200 pb-2 mb-3">Registration & Places
                        </h3>
                        <dl class="space-y-2">
                            {% if unit.max_places and unit.max_places > -1 %}
                            <div class="flex justify-between">
                                <dt class="text-base-content/60">Max Places</dt>
                                <dd class="font-medium text-base-content">{{ unit.max_places }}</dd>
                            </div>
                            {% elif unit.max_places == -1 %}
                            <div class="text-warning font-medium text-xs">
                                Limited places (Special selection)
                            </div>
                            {% endif %}

                            {% if unit.signup_start %}
                            <div class="flex justify-between">
                                <dt class="text-base-content/60">Signup Start</dt>
                                <dd class="font-medium text-base-content">{{ unit.signup_start }}</dd>
                            </div>
                            {% endif %}

                            {% if unit.signup_end %}
                            <div class="flex justify-between">
                                <dt class="text-base-content/60">Signup End</dt>
                                <dd class="font-medium text-base-content">{{ unit.signup_end }}</dd>
                            </div>
                            {% endif %}
                            {% if unit.priority %}
                            <div class="alert alert-warning p-2 text-xs">
                                <span><strong>Priority:</strong> {{ unit.priority }}</span>
                            </div>
                            {% endif %}
                        </dl>
                    </div>
                </section>
                {% endif %}

            </div>
        </div>

        {% if courses %}
        <section class="mt-8">
            <h3 class="text-xl font-bold text-base-content mb-4">Course Components</h3>
            <div class="card bg-base-100 shadow-sm overflow-hidden overflow-x-auto">
                <table class="table table-zebra w-full text-left text-sm">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Time & Place</th>
                            <th>Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for course in courses %}
                        <tr>
                            <td class="font-mono text-base-content/60">
                                {{ course.type.value if course.type else '?' }}
                            </td>
                            <td class="font-medium text-base-content">
                                {{ course.title if course.title else 'Course' }}
                                {% if course.comment %}
                                <div class="text-xs text-base-content/60 font-normal mt-1">{{ course.comment }}</div>
                                {% endif %}
                            </td>
                            <td class="text-base-content/80">
                                {% if course.timeslots %}
                                <ul class="space-y-1">
                                    {% for slot in course.timeslots %}
                                    <li>
                                        <span class="font-semibold">{{ slot.day }}</span>
                                        {{ slot.weekday }} {{ slot.start_time }}-{{ slot.end_time }}
                                        {% if slot.room %}<span class="text-neutral">({{ slot.building }} {{ slot.floor
                                            }} {{ slot.room }})</span>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <span class="text-base-content/40 italic">No time listed</span>
                                {% endif %}
                            </td>
                            <td class="text-base-content/70">
                                {% if course.hours %}
                                {{ course.hours|trim_float }} h {{ "weekly" if
                                course.hour_type.value
                                == 1 else 'semesterly' }}
                                {% else %}-{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
        {% endif %}


        {% if sections %}
        <section class="mt-8 mb-4">
            <h3 class="text-xl font-bold text-base-content mb-4">Offered In</h3>
            <ul class="card bg-base-100 shadow-sm space-y-1 p-5">
                {% for tree in sections recursive %}
                <li>
                    <div class="flex items-center gap-2 py-0.5">
                        <span class="h-0.5 w-3 bg-base-300 rounded-full"></span>
                        <a target="_blank"
                            href="https://www.vvz.ethz.ch/Vorlesungsverzeichnis/sucheLehrangebot.view?abschnittId={{ tree.section.id }}&semkez={{ tree.section.semkez }}&lang=en"
                            class="text-sm text-base-content font-medium hover:underline">
                            {{ tree.section.name_english if tree.section.name_english else tree.section.name }}
                            <span class="[&>svg]:size-3 inline-block">{% include "icons/external.svg"
                                %}</span>
                        </a>
                        {% if tree.section.comment_english or tree.section.comment %}
                        <span class="text-xs text-base-content/70 italic">
                            ({{ tree.section.comment_english if tree.section.comment_english else
                            tree.section.comment }})
                        </span>
                        {% endif %}
                    </div>

                    {% if tree.sub_sections %}
                    <ul class="pl-4 ml-1.5 border-l border-base-300">
                        {{ loop(tree.sub_sections) }}
                    </ul>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}
</main>

{% endblock content %}
